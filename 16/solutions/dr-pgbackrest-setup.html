



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This document provides instructions of how to set up and test the backup and disaster recovery solution in Percona Distribution for PostgreSQL with pgBackRest. For technical overview and architecture description of this solution, refer to Backup and disaster recovery in Percona Distribution for PostgreSQL.">
      
      
        <meta name="author" content="Percona LLC">
      
      
        <link rel="canonical" href="https://docs.percona.com/postgresql/16/solutions/dr-pgbackrest-setup.html">
      
      
        <link rel="prev" href="backup-recovery.html">
      
      
        <link rel="next" href="postgis.html">
      
      
      <link rel="icon" href="../_images/postgresql-fav.svg">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.25">
    
    
      
        <title>Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL - Percona Distribution for PostgreSQL</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://unicons.iconscout.com/release/v3.0.3/css/line.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    
      <link rel="stylesheet" href="../css/percona.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
      <link rel="stylesheet" href="../css/design.css">
    
      <link rel="stylesheet" href="../css/osano.css">
    
      <link rel="stylesheet" href="../css/landing.css">
    
      <link rel="stylesheet" href="../css/postgresql.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-J4J70BNH0G"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-J4J70BNH0G",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-J4J70BNH0G",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
               
                 
                 
                 
                 
                 <meta property="og:type" content="website" />
                 <meta property="og:title" content="Percona Distribution for PostgreSQL - Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL" />
                 <meta property="og:image" content="https://docs.percona.com/postgresql/16/_images/postgresql.png">
                 <meta property="og:url" content="https://docs.percona.com/postgresql/">
                </head>
                <body>
                </body>
              </html>
  
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploying-backup-and-disaster-recovery-solution-in-percona-distribution-for-postgresql" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      <!--
  Copyright (c) 2016-2024 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">

  <!-- Super Nav -->
  <div class="superNav">
    <div class="md-header__inner md-grid">
      <a href="https://docs.percona.com/percona-for-postgresql/" title="Percona Documentation home page">
        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <mask id="a" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
            <path d="M0 0h24v24H0z"/>
          </mask>
          <g mask="url(#a)">
            <path d="m7.825 13 5.6 5.6L12 20l-8-8 8-8 1.425 1.4-5.6 5.6H20v2H7.825Z"/>
          </g>
        </svg>
        <span>Percona Documentation</span>
      </a>
    </div>
  </div>

  <nav
    class="md-header__inner md-grid"
    aria-label="Header"
  >

    <!-- Link to home -->
    <a
      href="../index.html"
      title="Percona Distribution for PostgreSQL"
      class="md-header__button md-logo"
      aria-label="Percona Distribution for PostgreSQL"
      data-md-component="logo"
    >
      
  <img src="../_images/postgresql-mark.svg" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title">
      <div class="md-header__ellipsis">
        <a href="../index.html" class="md-header__topic">
          <span class="md-ellipsis">
            Percona Distribution for PostgreSQL
          </span>
        </a>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL
            
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Color theme set to Automatic. Click to change"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Color theme set to Automatic. Click to change" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="percona-light" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Color theme set to Light Mode. Click to change"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Color theme set to Light Mode. Click to change" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="percona-dark" data-md-color-primary="custom" data-md-color-accent="custom"  aria-label="Color theme set to Dark Mode. Click to change"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Color theme set to Dark Mode. Click to change" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>

      <!-- Search interface -->
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <a href="https://github.com/percona/postgresql-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    percona/postgresql-docs
  </div>
</a>
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Percona Distribution for PostgreSQL" class="md-nav__button md-logo" aria-label="Percona Distribution for PostgreSQL" data-md-component="logo">
      
  <img src="../_images/postgresql-mark.svg" alt="logo">

    </a>
    Percona Distribution for PostgreSQL
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/percona/postgresql-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    percona/postgresql-docs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Release Notes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Release Notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Release notes index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v16.2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 16.2 (2024-02-27)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v16.1.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 16.1 Update (2024-01-18)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v16.1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 16.1 (2023-11-29)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v16.0.upd.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 16.0 Update (2023-11-02)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../release-notes-v16.0.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Percona Distribution for PostgreSQL 16.0 (2023-09-19)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation and upgrade
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Installation and upgrade
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Install
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Install
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../apt.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install via apt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../yum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install via yum
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../enable-extensions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enable Percona Distribution for PostgreSQL extensions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../repo-overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositories overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run in Docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Upgrade
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Upgrade
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../major-upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Major upgrade
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../minor-upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Minor Upgrade of Percona Distribution for PostgreSQL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Migrate from PostgreSQL to Percona Distribution for PostgreSQL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Extensions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Extensions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extensions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contrib.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL contrib modules and utilities
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../third-party.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Third-party components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Percona-authored extensions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Percona-authored extensions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pg-stat-monitor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pg_stat_monitor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Solutions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Solutions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    High availability
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            High availability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="high-availability.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    High availability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ha-setup-apt.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying on Debian or Ubuntu
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ha-setup-yum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deploying on RHEL or derivatives
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pgbackrest.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pgBackRest setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ha-test.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing the Patroni PostgreSQL Cluster
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" checked>
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Backup and disaster recovery
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Backup and disaster recovery
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="backup-recovery.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="dr-pgbackrest-setup.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-hostnames" class="md-nav__link">
    <span class="md-ellipsis">
      Set up hostnames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-passwordless-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      Set up passwordless SSH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-percona-distribution-for-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      Install Percona Distribution for PostgreSQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-postgresql-on-the-primary-node-for-continuous-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Configure PostgreSQL on the primary node for continuous backup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Install pgBackRest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-pgbackrest-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create the pgBackRest configuration file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-pgbackrest-configuration-file-in-the-primary-node" class="md-nav__link">
    <span class="md-ellipsis">
      Update pgBackRest configuration file in the primary node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-pgbackrest-configuration-file-in-the-remote-backup-repository-node" class="md-nav__link">
    <span class="md-ellipsis">
      Update pgBackRest configuration file in the remote backup repository node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-pgbackrest-stanza-in-the-remote-backup-repository-node" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize pgBackRest stanza in the remote backup repository node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-backup-and-restore-with-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Backup and Restore with pgBackRest
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Backup and Restore with pgBackRest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-case-1-create-a-backup-with-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 1: Create a backup with pgBackRest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-2-restore-a-postgresql-instance-from-a-full-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 2: Restore a PostgreSQL Instance from a full backup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-3-point-in-time-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 3: Point-In-Time Recovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-4-restoring-to-a-separate-postgresql-instance" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 4: Restoring to a Separate PostgreSQL Instance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-expert-help" class="md-nav__link">
    <span class="md-ellipsis">
      Get expert help
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Spatial data handling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            Spatial data handling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-deploy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Query spatial data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="postgis-upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrade spatial database
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldap.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDAP authentication
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../uninstalling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Uninstall
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../telemetry.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telemetry
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../licensing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Licensing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../trademark-policy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trademark policy
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                    <br>
                    <label class="md-nav__title" for="__drawer">
    <a href="https://learn.percona.com/download-manual-percona-distribution-for-postgresql-16" onclick="_gaq.push(['b._trackEvent', 'Percona Distribution for PostgreSQL', 'Download', 'Download Manual Distribution for PostgreSQL']);" class="md-nav__link md-nav__link--active" style="font-size: .7rem;">
      Download PDF
    </a>
  </label> 
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-hostnames" class="md-nav__link">
    <span class="md-ellipsis">
      Set up hostnames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-up-passwordless-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      Set up passwordless SSH
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-percona-distribution-for-postgresql" class="md-nav__link">
    <span class="md-ellipsis">
      Install Percona Distribution for PostgreSQL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-postgresql-on-the-primary-node-for-continuous-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Configure PostgreSQL on the primary node for continuous backup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Install pgBackRest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-pgbackrest-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create the pgBackRest configuration file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-pgbackrest-configuration-file-in-the-primary-node" class="md-nav__link">
    <span class="md-ellipsis">
      Update pgBackRest configuration file in the primary node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-pgbackrest-configuration-file-in-the-remote-backup-repository-node" class="md-nav__link">
    <span class="md-ellipsis">
      Update pgBackRest configuration file in the remote backup repository node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-pgbackrest-stanza-in-the-remote-backup-repository-node" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize pgBackRest stanza in the remote backup repository node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-backup-and-restore-with-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Backup and Restore with pgBackRest
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Backup and Restore with pgBackRest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-case-1-create-a-backup-with-pgbackrest" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 1: Create a backup with pgBackRest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-2-restore-a-postgresql-instance-from-a-full-backup" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 2: Restore a PostgreSQL Instance from a full backup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-3-point-in-time-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 3: Point-In-Time Recovery
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-case-4-restoring-to-a-separate-postgresql-instance" class="md-nav__link">
    <span class="md-ellipsis">
      Use Case 4: Restoring to a Separate PostgreSQL Instance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-expert-help" class="md-nav__link">
    <span class="md-ellipsis">
      Get expert help
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                

          
                  

  
    <a href="https://github.com/percona/postgresql-docs/edit/16/docs/solutions/dr-pgbackrest-setup.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/percona/postgresql-docs/raw/16/docs/solutions/dr-pgbackrest-setup.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg>
    </a>
  


<h1 id="deploying-backup-and-disaster-recovery-solution-in-percona-distribution-for-postgresql">Deploying backup and disaster recovery solution in Percona Distribution for PostgreSQL<a class="headerlink" href="#deploying-backup-and-disaster-recovery-solution-in-percona-distribution-for-postgresql" title="Permanent link">&para;</a></h1>
<p>This document provides instructions of how to set up and test the backup and disaster recovery solution in Percona Distribution for PostgreSQL with <code>pgBackRest</code>. For technical overview and architecture description of this solution, refer to <a href="backup-recovery.html">Backup and disaster recovery in Percona Distribution for PostgreSQL</a>.</p>
<h2 id="deployment">Deployment<a class="headerlink" href="#deployment" title="Permanent link">&para;</a></h2>
<p>As the example configuration, we will use the nodes with the following IP addresses:</p>
<table>
<thead>
<tr>
<th><strong>Node name</strong></th>
<th><strong>Internal IP address</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>pg-primary</td>
<td>10.104.0.3</td>
</tr>
<tr>
<td>pg-repo</td>
<td>10.104.0.5</td>
</tr>
<tr>
<td>pg-secondary</td>
<td>10.104.0.4</td>
</tr>
</tbody>
</table>
<h3 id="set-up-hostnames">Set up hostnames<a class="headerlink" href="#set-up-hostnames" title="Permanent link">&para;</a></h3>
<p>In our architecture, the <code>pgBackRest</code> repository is located on a remote host. To allow communication among the nodes, passwordless SSH is required. To achieve this, properly setting up hostnames in the <code>/etc/hosts</code> files is very important.</p>
<ol>
<li>
<p>Define the hostname for every server in the <code>/etc/hostname</code> file. The following are the examples of how the <code>/etc/hostname</code> file in three nodes looks like:</p>
<div class="highlight"><pre><span></span><code>cat /etc/hostname
pg-primary
</code></pre></div>
<div class="highlight"><pre><span></span><code>cat /etc/hostname
pg-repo
</code></pre></div>
<div class="highlight"><pre><span></span><code>cat /etc/hostname
pg-secondary
</code></pre></div>
</li>
<li>
<p>For the nodes to communicate seamlessly across the network, resolve their hostnames to their IP addresses in the <code>/etc/hosts</code> file.  (Alternatively, you can make appropriate entries in your internal DNS servers)</p>
</li>
</ol>
<p>The <code>/etc/hosts</code> file  for the <code>pg-primary node</code> looks like this:</p>
<div class="highlight"><pre><span></span><code>```
127.0.1.1 pg-primary pg-primary
127.0.0.1 localhost
10.104.0.5 pg-repo
```
</code></pre></div>
<p>The <code>/etc/hosts</code> file in the <code>pg-repo</code> node looks like this:</p>
<div class="highlight"><pre><span></span><code>```
127.0.1.1 pg-repo pg-repo
127.0.0.1 localhost
10.104.0.3 pg-primary
10.104.0.4 pg-secondary
```
</code></pre></div>
<p>The <code>/etc/hosts</code> file in the <code>pg-secondary</code> node is shown below:</p>
<div class="highlight"><pre><span></span><code>```
127.0.1.1 pg-secondary pg-secondary
127.0.0.1 localhost
10.104.0.3 pg-primary
10.104.0.5 pg-repo
```
</code></pre></div>
<h3 id="set-up-passwordless-ssh">Set up passwordless SSH<a class="headerlink" href="#set-up-passwordless-ssh" title="Permanent link">&para;</a></h3>
<p>Before setting up passwordless SSH, ensure that the <em>postgres</em> user in all three instances has a password. </p>
<ol>
<li>
<p>To set or change the password, run the following command <strong>as a root user</strong>:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>passwd<span class="w"> </span>postgres
</code></pre></div>
</li>
<li>
<p>Type the new password and confirm it. </p>
</li>
<li>
<p>After setting up the password, edit the <code>/etc/ssh/sshd_config</code> file and ensure the <code>PasswordAuthentication</code> variable is set as <code>yes</code>. </p>
<div class="highlight"><pre><span></span><code>PasswordAuthentication yes 
</code></pre></div>
</li>
<li>
<p>In the <code>pg-repo</code> node, restart the <code>sshd</code> service. Without the restart, the SSH server will not allow you to connect to it using a password while adding the keys.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>service<span class="w"> </span>sshd<span class="w"> </span>restart
</code></pre></div>
</li>
<li>
<p>In the <code>pg-primary</code> node, generate an SSH key pair and add the public key to the <code>pg-repo</code> node. </p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Run the commands as the <strong>postgres</strong> user. </p>
</div>
<ul>
<li>
<p>Generate SSH keys:   </p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa
Generating<span class="w"> </span>public/private<span class="w"> </span>rsa<span class="w"> </span>key<span class="w"> </span>pair.
Enter<span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span>which<span class="w"> </span>to<span class="w"> </span>save<span class="w"> </span>the<span class="w"> </span>key<span class="w"> </span><span class="o">(</span>/root/.ssh/id_rsa<span class="o">)</span>:<span class="w"> </span>
Enter<span class="w"> </span>passphrase<span class="w"> </span><span class="o">(</span>empty<span class="w"> </span><span class="k">for</span><span class="w"> </span>no<span class="w"> </span>passphrase<span class="o">)</span>:<span class="w"> </span>
Enter<span class="w"> </span>same<span class="w"> </span>passphrase<span class="w"> </span>again:<span class="w"> </span>
Your<span class="w"> </span>identification<span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span><span class="k">in</span><span class="w"> </span>/root/.ssh/id_rsa
Your<span class="w"> </span>public<span class="w"> </span>key<span class="w"> </span>has<span class="w"> </span>been<span class="w"> </span>saved<span class="w"> </span><span class="k">in</span><span class="w"> </span>/root/.ssh/id_rsa.pub
The<span class="w"> </span>key<span class="w"> </span>fingerprint<span class="w"> </span>is:
...
</code></pre></div>
</li>
<li>
<p>Copy the public key to the <code>pg-repo</code> node:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa.pub<span class="w"> </span>postgres@pg-repo
/usr/bin/ssh-copy-id:<span class="w"> </span>INFO:<span class="w"> </span>Source<span class="w"> </span>of<span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>installed:<span class="w"> </span><span class="s2">&quot;/root/.ssh/id_rsa.pub&quot;</span>
/usr/bin/ssh-copy-id:<span class="w"> </span>INFO:<span class="w"> </span>attempting<span class="w"> </span>to<span class="w"> </span>log<span class="w"> </span><span class="k">in</span><span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span>,<span class="w"> </span>to<span class="w"> </span>filter<span class="w"> </span>out<span class="w"> </span>any<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>already<span class="w"> </span>installed
/usr/bin/ssh-copy-id:<span class="w"> </span>INFO:<span class="w"> </span><span class="m">1</span><span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>remain<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>installed<span class="w"> </span>--<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>prompted<span class="w"> </span>now<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>to<span class="w"> </span>install<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>keys
postgres@pg-repo<span class="s1">&#39;s password: </span>

<span class="s1">Number of key(s) added: 1</span>


<span class="s1">Now try logging into the machine, with:   &quot;ssh &#39;</span>postgres@pg-repo<span class="err">&#39;</span><span class="s2">&quot;</span>
<span class="s2">and check to make sure that only the key(s) you wanted were added.</span>
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>To verify everything has worked as expected, run the following command from the <code>pg-primary</code> node. </p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>ssh<span class="w"> </span>postgres@pg-repo
</code></pre></div>
<p>You should be able to connect to the <code>pg-repo</code> terminal without a password.</p>
</li>
<li>
<p>Repeat the SSH connection from <code>pg-repo</code> to <code>pg-primary</code> to ensure that passwordless SSH is working. </p>
</li>
<li>Set up bidirectional passwordless SSH between <code>pg-repo</code> and <code>pg-secondary</code> using the same method. This will allow <code>pg-repo</code> to recover the backups to <code>pg-secondary</code>. </li>
</ol>
<h3 id="install-percona-distribution-for-postgresql">Install Percona Distribution for PostgreSQL<a class="headerlink" href="#install-percona-distribution-for-postgresql" title="Permanent link">&para;</a></h3>
<p>Install Percona Distribution for PostgreSQL in the primary and the secondary nodes from Percona repository. </p>
<ol>
<li><a href="https://www.percona.com/doc/percona-repo-config/installing.html">Install <code>percona-release</code></a>.</li>
<li>
<p>Enable the repository:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>percona-release<span class="w"> </span>setup<span class="w"> </span>ppg16
</code></pre></div>
</li>
<li>
<p>Install Percona Distribution for PostgreSQL packages</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">On Debian and Ubuntu</label><label for="__tabbed_1_2">On RedHat Enterprise Linux and derivatives</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>percona-postgresql-16<span class="w"> </span>-y
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>percona-postgresql16-server
</code></pre></div>
</div>
</div>
</div>
</li>
</ol>
<h3 id="configure-postgresql-on-the-primary-node-for-continuous-backup">Configure PostgreSQL on the primary node for continuous backup<a class="headerlink" href="#configure-postgresql-on-the-primary-node-for-continuous-backup" title="Permanent link">&para;</a></h3>
<p>At this step, configure the PostgreSQL instance on the <code>pg-primary</code> node for continuous archiving of the WAL files. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On Debian and Ubuntu, the path to the configuration file is <code>/etc/postgresql/16/main/postgresql.conf</code>.</p>
<p>On RHEL and CentOS, the path to the configuration file is <code>/var/lib/pgsql/16/data/</code>.</p>
</div>
<ol>
<li>
<p>Edit the <code>postgresql.conf</code> configuration file to include the following changes:</p>
<div class="highlight"><pre><span></span><code>archive_command = &#39;pgbackrest --stanza=prod_backup archive-push %p&#39;
archive_mode = on
listen_addresses = &#39;*&#39;
log_line_prefix = &#39;&#39;
max_wal_senders = 3
wal_level = replica
</code></pre></div>
</li>
<li>
<p>Once the changes are saved, restart PostgreSQL.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>postgresql
</code></pre></div>
</li>
</ol>
<h3 id="install-pgbackrest">Install pgBackRest<a class="headerlink" href="#install-pgbackrest" title="Permanent link">&para;</a></h3>
<p>Install <code>pgBackRest</code> in all three instances from Percona repository. Use the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">On Debian / Ubuntu</label><label for="__tabbed_2_2">On RHEL / derivatives</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>percona-pgbackrest
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>yum<span class="w"> </span>install<span class="w"> </span>percona-pgbackrest
</code></pre></div>
</div>
</div>
</div>
<h3 id="create-the-pgbackrest-configuration-file">Create the <code>pgBackRest</code> configuration file<a class="headerlink" href="#create-the-pgbackrest-configuration-file" title="Permanent link">&para;</a></h3>
<p>Run the following commands on all three nodes to set up the required configuration file for <code>pgBackRest</code>.</p>
<ol>
<li>
<p>Configure a location and permissions for the <code>pgBackRest</code> log rotation:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>-m<span class="w"> </span><span class="m">770</span><span class="w"> </span>/var/log/pgbackrest
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>postgres:postgres<span class="w"> </span>/var/log/pgbackrest
</code></pre></div>
</li>
<li>
<p>Configure the location and permissions for the <code>pgBackRest</code> configuration file:</p>
</li>
</ol>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/pgbackrest
$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/etc/pgbackrest/conf.d
$<span class="w"> </span>sudo<span class="w"> </span>touch<span class="w"> </span>/etc/pgbackrest/pgbackrest.conf
$<span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">640</span><span class="w"> </span>/etc/pgbackrest/pgbackrest.conf
$<span class="w"> </span>sudo<span class="w"> </span>chown<span class="w"> </span>postgres:postgres<span class="w"> </span>/etc/pgbackrest/pgbackrest.conf
$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/home/pgbackrest
$<span class="w"> </span>sudo<span class="w"> </span>chmod<span class="w"> </span>postgres:postgres<span class="w"> </span>/home/pgbackrest
</code></pre></div>
<h3 id="update-pgbackrest-configuration-file-in-the-primary-node">Update <code>pgBackRest</code> configuration file in the primary node<a class="headerlink" href="#update-pgbackrest-configuration-file-in-the-primary-node" title="Permanent link">&para;</a></h3>
<p>Configure <code>pgBackRest</code> on the <code>pg-primary</code> node by setting up a stanza. A stanza is a set of configuration parameters that tells <code>pgBackRest</code> where to backup its files. Edit the <code>/etc/pgbackrest/pgbackrest.conf</code> file in the <code>pg-primary</code> node to include the following lines:</p>
<div class="highlight"><pre><span></span><code>[global]
repo1-host=pg-repo 
repo1-host-user=postgres
process-max=2
log-level-console=info
log-level-file=debug

[prod_backup]
pg1-path=/var/lib/postgresql/14/main
</code></pre></div>
<p>You can see the <code>pg1-path</code> attribute for the <code>prod_backup</code> stanza has been set to the PostgreSQL data folder.</p>
<h3 id="update-pgbackrest-configuration-file-in-the-remote-backup-repository-node">Update <code>pgBackRest</code> configuration file in the remote backup repository node<a class="headerlink" href="#update-pgbackrest-configuration-file-in-the-remote-backup-repository-node" title="Permanent link">&para;</a></h3>
<p>Add a stanza for the <code>pgBackRest</code> in the <code>pg-repo</code> node. Edit the <code>/etc/pgbackrest/pgbackrest.conf</code> configuration file to include the following lines:</p>
<div class="highlight"><pre><span></span><code>[global]
repo1-path=/home/pgbackrest/pg_backup
repo1-retention-full=2
process-max=2
log-level-console=info
log-level-file=debug
start-fast=y
stop-auto=y

[prod_backup]
pg1-path=/var/lib/postgresql/14/main
pg1-host=pg-primary
pg1-host-user=postgres
pg1-port = 5432
</code></pre></div>
<h3 id="initialize-pgbackrest-stanza-in-the-remote-backup-repository-node">Initialize <code>pgBackRest</code> stanza in the remote backup repository node<a class="headerlink" href="#initialize-pgbackrest-stanza-in-the-remote-backup-repository-node" title="Permanent link">&para;</a></h3>
<p>After the configuration files are set up, its now time to initialize the <code>pgBackRest</code> stanza. Run the following command in the remote backup repository node (<code>pg-repo</code>).</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>pgbackrest<span class="w"> </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>stanza-create
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">11</span>:08:18.157<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>stanza-create<span class="w"> </span><span class="nb">command</span><span class="w"> </span>begin<span class="w"> </span><span class="m">2</span>.36:<span class="w"> </span>--exec-id<span class="o">=</span><span class="m">155883</span>-2277a3e7<span class="w"> </span>--log-level-console<span class="o">=</span>info<span class="w"> </span>--log-level-file<span class="o">=</span>off<span class="w"> </span>--pg1-host<span class="o">=</span>pg-primary<span class="w"> </span>--pg1-host-user<span class="o">=</span>postgres<span class="w"> </span>--pg1-path<span class="o">=</span>/var/lib/postgresql/14/main<span class="w"> </span>--pg1-port<span class="o">=</span><span class="m">5432</span><span class="w"> </span>--repo1-path<span class="o">=</span>/home/pgbackrest/pg_backup<span class="w"> </span>--stanza<span class="o">=</span>prod_backup
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">11</span>:08:19.453<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>stanza-create<span class="w"> </span><span class="k">for</span><span class="w"> </span>stanza<span class="w"> </span><span class="s1">&#39;prod_backup&#39;</span><span class="w"> </span>on<span class="w"> </span>repo1
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">11</span>:08:19.566<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>stanza-create<span class="w"> </span><span class="nb">command</span><span class="w"> </span>end:<span class="w"> </span>completed<span class="w"> </span>successfully<span class="w"> </span><span class="o">(</span>1412ms<span class="o">)</span>
</code></pre></div>
<p>Once the stanza is created successfully, you can try out the different use cases for disaster recovery.</p>
<h2 id="testing-backup-and-restore-with-pgbackrest">Testing Backup and Restore with <code>pgBackRest</code><a class="headerlink" href="#testing-backup-and-restore-with-pgbackrest" title="Permanent link">&para;</a></h2>
<p>This section covers a few use cases where <code>pgBackRest</code> can back up and restore databases either in the same instance or a different node.</p>
<h3 id="use-case-1-create-a-backup-with-pgbackrest">Use Case 1: Create a backup with <code>pgBackRest</code><a class="headerlink" href="#use-case-1-create-a-backup-with-pgbackrest" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>To start our testing, lets create a table in the <code>postgres</code> database in the <code>pg-primary</code> node and add some data.</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">CUSTOMER</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">CUSTOMER</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;john&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">CUSTOMER</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;martha&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">CUSTOMER</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;mary&#39;</span><span class="p">);</span>
</code></pre></div>
</li>
<li>
<p>Take a full backup of the database instance. Run the following commands from the <code>pg-repo</code> node:</p>
</li>
</ol>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>pgbackrest<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w">  </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>backup<span class="w"> </span>--type<span class="o">=</span>full
</code></pre></div>
<p>If you want an incremental backup, you can omit the <code>type</code> attribute. By default, <code>pgBackRest</code> always takes an incremental backup except the first backup of the cluster which is always a full backup. </p>
<p>If you need a differential backup,  use <em>diff</em> for the <code>type</code> field:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>pgbackrest<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>backup<span class="w"> </span>--type<span class="o">=</span>diff
</code></pre></div>
<h3 id="use-case-2-restore-a-postgresql-instance-from-a-full-backup">Use Case 2: Restore a PostgreSQL Instance from a full backup<a class="headerlink" href="#use-case-2-restore-a-postgresql-instance-from-a-full-backup" title="Permanent link">&para;</a></h3>
<p>For testing purposes, let&rsquo;s &ldquo;damage&rdquo; the PostgreSQL instance. </p>
<ol>
<li>
<p>Run the following command in the <code>pg-primary</code> node to delete the main data directory.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/postgresql/14/main/*
</code></pre></div>
</li>
<li>
<p>To restore the backup, run the following commands. </p>
<ul>
<li>Stop the <code>postgresql</code> instance</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>postgresql
</code></pre></div>
<ul>
<li>Restore the backup:</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>pgbackrest<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>restore
</code></pre></div>
<ul>
<li>Start the <code>postgresql</code> instance</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>postgresql
</code></pre></div>
</li>
<li>
<p>After the command executes successfully, you can access PostgreSQL from the <code>psql</code> command line tool and check if the table and data rows have been restored.</p>
</li>
</ol>
<h3 id="use-case-3-point-in-time-recovery">Use Case 3: Point-In-Time Recovery<a class="headerlink" href="#use-case-3-point-in-time-recovery" title="Permanent link">&para;</a></h3>
<p>If your target PostgreSQL instance has an already existing data directory, the full restore option will fail. You will get an error message stating there are existing data files.  In this case, you can use the <code>--delta</code> option to restore only the corrupted files. </p>
<p>For example, let&rsquo;s say one of your developers mistakenly deleted a few rows from a table. You can use <code>pgBackRest</code> to revert your database to a previous point in time to recover the lost rows.</p>
<p>To test this use case, do the following:</p>
<ol>
<li>
<p>Take a timestamp when the database is stable and error-free. Run the following command from the <code>psql</code>prompt.</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">;</span>
<span class="w">       </span><span class="k">current_timestamp</span><span class="w">       </span>
<span class="c1">-------------------------------</span>
<span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">07</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">47</span><span class="p">.</span><span class="mi">952405</span><span class="o">+</span><span class="mi">00</span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span>
</code></pre></div>
<p>Note down the above timestamp since we will use this time in the restore command. Note that in a real life scenario, finding the correct point in time when the database was error-free may require extensive investigation. It is also important to note that all changes after the selected point will be lost after the roll back. </p>
</li>
<li>
<p>Delete one of the customer records added before.</p>
<div class="highlight"><pre><span></span><code><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">CUSTOMER</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
</code></pre></div>
</li>
<li>
<p>To recover the data, run a command with the noted timestamp as an argument. Run the commands below to recover the database up to that time.</p>
<ul>
<li>Stop the <code>postgresql</code> instance</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>postgresql
</code></pre></div>
<ul>
<li>Restore the backup</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>pgbackrest<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>--delta<span class="w"> </span><span class="se">\</span>
--type<span class="o">=</span><span class="nb">time</span><span class="w"> </span><span class="s2">&quot;--target= 2021-11-07 11:55:47.952405+00&quot;</span><span class="w"> </span><span class="se">\</span>
--target-action<span class="o">=</span>promote<span class="w"> </span>restore
</code></pre></div>
<ul>
<li>Start the <code>postgresql</code> instance</li>
</ul>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>postgresql
</code></pre></div>
</li>
<li>
<p>Check the database table to see if the record has been restored.</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customer</span><span class="p">;</span>
<span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">name</span><span class="w">  </span>
<span class="c1">----+--------</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">john</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">martha</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">mary</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
</li>
</ol>
<h3 id="use-case-4-restoring-to-a-separate-postgresql-instance">Use Case 4: Restoring to a Separate PostgreSQL Instance<a class="headerlink" href="#use-case-4-restoring-to-a-separate-postgresql-instance" title="Permanent link">&para;</a></h3>
<p>Sometimes a PostgreSQL server may encounter hardware issues and become completely inaccessible. In such cases, we will need to recover the database to a separate instance where <code>pgBackRest</code> is not initially configured. To restore the instance to a separate host, you have to first install both PostgreSQL and <code>pgBackRest</code> in this host. </p>
<p>In our test setup, we already have PostgreSQL and <code>pgBackRest</code> installed in the third node, <code>pg-secondary</code>. Change the <code>pgBackRest</code> configuration file in the <code>pg-secondary</code> node as shown below.</p>
<div class="highlight"><pre><span></span><code>[global]
repo1-host=pg-repo
repo1-host-user=postgres
process-max=2
log-level-console=info
log-level-file=debug

[prod_backup]
pg1-path=/var/lib/postgresql/14/main
</code></pre></div>
<p>There should be bidirectional passwordless SSH communication between <code>pg-repo</code> and <code>pg-secondary</code>. Refer to the <a href="#set-up-passwordless-ssh">Set up passwordless SSH</a> section for the steps, if you havent configured it. </p>
<p>Stop the PostgreSQL instance</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>postgresql
</code></pre></div>
<p>Restore the database backup from <code>pg-repo</code> to <code>pg-secondary</code>.</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>pgbackrest<span class="w"> </span>-u<span class="w"> </span>postgres<span class="w"> </span>--stanza<span class="o">=</span>prod_backup<span class="w"> </span>--delta<span class="w"> </span>restore

<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:08.897<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>restore<span class="w"> </span><span class="nb">command</span><span class="w"> </span>begin<span class="w"> </span><span class="m">2</span>.36:<span class="w"> </span>--delta<span class="w"> </span>--exec-id<span class="o">=</span><span class="m">109728</span>-d81c7b0b<span class="w"> </span>--log-level-console<span class="o">=</span>info<span class="w"> </span>--log-level-file<span class="o">=</span>debug<span class="w"> </span>--pg1-path<span class="o">=</span>/var/lib/postgresql/14/main<span class="w"> </span>--process-max<span class="o">=</span><span class="m">2</span><span class="w"> </span>--repo1-host<span class="o">=</span>pg-repo<span class="w"> </span>--repo1-host-user<span class="o">=</span>postgres<span class="w"> </span>--stanza<span class="o">=</span>prod_backup
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:09.784<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>repo1:<span class="w"> </span>restore<span class="w"> </span>backup<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="m">20211107</span>-111534F_20211107-131807I,<span class="w"> </span>recovery<span class="w"> </span>will<span class="w"> </span>start<span class="w"> </span>at<span class="w"> </span><span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:18:07
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:09.786<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>remove<span class="w"> </span>invalid<span class="w"> </span>files/links/paths<span class="w"> </span>from<span class="w"> </span><span class="s1">&#39;/var/lib/postgresql/14/main&#39;</span>
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:11.803<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>write<span class="w"> </span>updated<span class="w"> </span>/var/lib/postgresql/14/main/postgresql.auto.conf
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:11.819<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>restore<span class="w"> </span>global/pg_control<span class="w"> </span><span class="o">(</span>performed<span class="w"> </span>last<span class="w"> </span>to<span class="w"> </span>ensure<span class="w"> </span>aborted<span class="w"> </span>restores<span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>started<span class="o">)</span>
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:11.819<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>restore<span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">23</span>.2MB,<span class="w"> </span>file<span class="w"> </span><span class="nv">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">937</span>
<span class="m">2021</span>-11-07<span class="w"> </span><span class="m">13</span>:34:11.820<span class="w"> </span>P00<span class="w">   </span>INFO:<span class="w"> </span>restore<span class="w"> </span><span class="nb">command</span><span class="w"> </span>end:<span class="w"> </span>completed<span class="w"> </span>successfully<span class="w"> </span><span class="o">(</span>2924ms<span class="o">)</span>
</code></pre></div>
<p>After the restore completes successfully, restart PostgreSQL:</p>
<div class="highlight" data-prompt="$"><pre><span></span><code>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>postgresql
</code></pre></div>
<p>Check the database contents from the local <code>psql</code> shell. </p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">customer</span><span class="p">;</span>
<span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">name</span><span class="w">  </span>
<span class="c1">----+--------</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">john</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">martha</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">mary</span>
<span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span>
</code></pre></div>
<div data-banner="data-banner">
<h2 class="title" id="get-expert-help">Get expert help<a class="headerlink" href="#get-expert-help" title="Permanent link">&para;</a></h2>
<p>If you need assistance, visit the community forum for comprehensive and free database knowledge, or contact our Percona Database Experts for professional support and services.</p>
<div class="actions">
<p><a href="https://forums.percona.com/c/postgresql/25?utm_campaign=Doc%20pages"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 4v7H5.17L4 12.17V4h11m1-2H3a1 1 0 0 0-1 1v14l4-4h10a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1m5 4h-2v9H6v2a1 1 0 0 0 1 1h11l4 4V7a1 1 0 0 0-1-1Z"/></svg></span> Community Forum</a> <a href="https://www.percona.com/about/contact"><span class="twemoji"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M19.3996 14.148C21.9082 12.5083 22.7289 9.16368 21.2109 6.53493C20.4502 5.21636 19.2207 4.27206 17.7497 3.87776C16.3868 3.51187 14.9634 3.6615 13.7106 4.29444L12 1.33337L8.44934 7.48295L0.242432 21.6959H23.7576L19.3996 14.148ZM17.3474 5.38416C18.4167 5.66894 19.3064 6.35548 19.8606 7.31143C20.9499 9.19582 20.384 11.5859 18.6176 12.7931L14.4917 5.64797C15.3806 5.22055 16.3831 5.12734 17.3474 5.38416ZM12 4.45432L21.0533 20.135H15.7562L9.35029 9.04341L11.9995 4.45478L12 4.45432ZM2.94667 20.135L8.44888 10.6071L13.9511 20.135H2.94667Z"/>
</svg></span> Get a Percona Expert</a></p>
</div>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">September 19, 2023</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">January 21, 2022</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thank you for your feedback! Help us improve by using our  <a href="https://docs.google.com/forms/d/1bkWACehjqlwA0AKf-qTJcXvYbOSYgze8iTPXjntqmNo/edit" target="_blank" rel="noopener"> feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                

          <script>
                  !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
                  posthog.init('phc_7unoI9J6Fm0SMrfDp35xNOpCRTkOAibbffQwdGWbHnL',{api_host:'https://eu.posthog.com'})
          </script>

          
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
    <div class="md-copyright__highlight">
 <a href='https://percona.com' target='_blank'>Percona LLC and/or its affiliates, </a> &copy; 2024  <a href="#" onclick="Osano.cm.showDrawer('osano-cm-dom-info-dialog-open')">Cookie Preferences</a>
    </div>
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["search.highlight", "navigation.top", "navigation.tracking", "content.tabs.link", "content.action.edit", "content.action.view", "content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
<script src="https://cmp.osano.com/Azqe5vTyLOSbN3OuT/49ad85b5-0418-4794-ab81-7599dddd534c/osano.js"></script>

      <script src="../assets/javascripts/bundle.081f42fc.min.js"></script>
      
        <script src="../js/version-select.js"></script>
      
        <script src="../js/promptremover.js"></script>
      
        <script src="../js/consent.css"></script>
      
    

  </body>
</html>